name: Android CI test build

on:
  push:
    branches:
      - "feature/*"
      - "develop"
  pull_request:
    branches:
      - "feature/*"
      - "develop"


jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: gradle
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build with Gradle
        run: ./gradlew build

  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Clone repo
        uses: actions/checkout@main
        with:
          fetch-depth: 1
      - name: ktlint
        uses: ScaCap/action-ktlint@master
        with:
          github_token: ${{ secrets.ACTION_TOKEN }}
          reporter: github-pr-review
          android: true
          fail_on_error: true
          level: warning

  test:
    runs-on: macos-latest # or any other machine
    steps:
      - name: Unit Test
      run: ./gradlew testDebugUnitTest

        - name: Upload Test Reports Folder
          uses: actions/upload-artifact@v2
          if: ${{ always() }} # IMPORTANT: Upload reports regardless of status
          with:
            name: reports
            path: app/build/test-results # path to where the xml test results are stored

  report:
    runs-on: ubuntu-latest
    needs: test # The report job will run after test job
    if: ${{ always() }} # IMPORTANT: Execute report job regardless of status
    steps:
      - name: Download Test Reports Folder
        uses: actions/download-artifact@v2
        with:
          name: reports

      - name: Android Test Report
        uses: asadmansr/android-test-report-action@v1.2.0